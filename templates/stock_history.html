<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Price History - S&P 500 Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        .header h1 {
            font-weight: 700;
            margin-bottom: 10px;
        }
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .stock-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        .loading i {
            font-size: 2em;
            margin-bottom: 15px;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        .no-results i {
            font-size: 3em;
            margin-bottom: 15px;
            color: #bdc3c7;
        }
        .nav-link {
            color: #667eea;
            font-weight: 600;
        }
        .nav-link:hover {
            color: #764ba2;
        }
        .nav-link.active {
            background: #667eea !important;
            color: white !important;
        }
        .table th {
            font-weight: 600;
            font-size: 0.9em;
        }
        .table td {
            vertical-align: middle;
            font-size: 0.9em;
        }
        .text-success {
            font-weight: 600;
        }
        .text-danger {
            font-weight: 600;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <div class="main-container">
                    <!-- Header -->
                    <div class="header">
                        <h1><i class="fas fa-chart-line"></i> Stock Price History</h1>
                        <p>View detailed price history for any S&P 500 stock</p>
                        <nav class="nav nav-pills justify-content-center mt-3">
                            <a class="nav-link" href="/"><i class="fas fa-home"></i> Price Dip Analysis</a>
                            <a class="nav-link active" href="/stock_history"><i class="fas fa-chart-area"></i> Stock History</a>
                            <a class="nav-link" href="/admin"><i class="fas fa-chart-line"></i> Usage Analytics</a>
                        </nav>
                    </div>

                    <!-- Stock Selection -->
                    <div class="filter-section">
                        <h4><i class="fas fa-search"></i> Select Stock</h4>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="stockSelect" class="form-label">Stock Symbol</label>
                                <select class="form-select" id="stockSelect">
                                    <option value="">Select a stock...</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="historyStartDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="historyStartDate">
                            </div>
                            <div class="col-md-3">
                                <label for="historyEndDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="historyEndDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="loadStockHistory()">
                                    <i class="fas fa-chart-line"></i> Load Chart
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stock Info -->
                    <div class="stock-info" id="stockInfo" style="display: none;">
                        <div class="row">
                            <div class="col-md-3">
                                <h5><i class="fas fa-building"></i> Company</h5>
                                <p id="companyName">-</p>
                            </div>
                            <div class="col-md-3">
                                <h5><i class="fas fa-calendar"></i> Date Range</h5>
                                <p id="dateRange">-</p>
                            </div>
                            <div class="col-md-3">
                                <h5><i class="fas fa-chart-bar"></i> Data Points</h5>
                                <p id="dataPoints">-</p>
                            </div>
                            <div class="col-md-3">
                                <h5><i class="fas fa-dollar-sign"></i> Current Price</h5>
                                <p id="currentPrice">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Container -->
                    <div class="chart-container">
                        <div id="chartLoading" class="loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading stock data and generating chart...</p>
                        </div>
                        <div id="chartError" class="no-results" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p id="errorMessage">Error loading chart data.</p>
                        </div>
                        <canvas id="priceChart" style="display: none;"></canvas>
                    </div>

                    <!-- Price Data Table -->
                    <div class="chart-container" id="priceTableContainer" style="display: none;">
                        <h4><i class="fas fa-table"></i> Price Data Table</h4>
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Prev Day Open</th>
                                        <th>Open Price</th>
                                        <th>Daily Change (%)</th>
                                        <th>Volume</th>
                                    </tr>
                                </thead>
                                <tbody id="priceTableBody">
                                    <!-- Table data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <label for="tablePageSize" class="form-label">Show:</label>
                                <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="tablePageSize">
                                    <option value="10">10 rows</option>
                                    <option value="25" selected>25 rows</option>
                                    <option value="50">50 rows</option>
                                    <option value="100">100 rows</option>
                                </select>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary btn-sm" onclick="previousPage()">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <span class="mx-2" id="pageInfo">Page 1 of 1</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="nextPage()">
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Price Statistics -->
                    <div class="row" id="priceStats" style="display: none;">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h6 class="card-title">Highest Open Price</h6>
                                    <h4 id="highestPrice" class="text-success">-</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h6 class="card-title">Lowest Open Price</h6>
                                    <h4 id="lowestPrice" class="text-danger">-</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h6 class="card-title">Average Open Price</h6>
                                    <h4 id="averagePrice" class="text-primary">-</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h6 class="card-title">Total Return</h6>
                                    <h4 id="totalReturn" class="text-info">-</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let priceChart = null;
        let currentStockData = [];
        let currentPage = 1;
        let pageSize = 25;

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadStocksList();
            setDefaultDates();
            
            // Add event listener for page size change
            document.getElementById('tablePageSize').addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1;
                displayPriceTable();
            });
        });

        function setDefaultDates() {
            // Set default date range (last 2 years)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setFullYear(startDate.getFullYear() - 2);
            
            document.getElementById('historyStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('historyEndDate').value = endDate.toISOString().split('T')[0];
        }

        function loadStocksList() {
            fetch('/api/stocks')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('stockSelect');
                        data.stocks.forEach(stock => {
                            const option = document.createElement('option');
                            option.value = stock.symbol;
                            option.textContent = `${stock.symbol} - ${stock.name}`;
                            select.appendChild(option);
                        });
                    } else {
                        console.error('Error loading stocks:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading stocks:', error);
                });
        }

        function loadStockHistory() {
            const symbol = document.getElementById('stockSelect').value;
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;

            if (!symbol) {
                alert('Please select a stock');
                return;
            }

            // Show loading
            document.getElementById('chartLoading').style.display = 'block';
            document.getElementById('chartError').style.display = 'none';
            document.getElementById('priceChart').style.display = 'none';
            document.getElementById('priceTableContainer').style.display = 'none';
            document.getElementById('stockInfo').style.display = 'none';
            document.getElementById('priceStats').style.display = 'none';

            // Build query parameters
            const params = new URLSearchParams({
                symbol: symbol
            });
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            fetch(`/api/stock_history?${params}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('chartLoading').style.display = 'none';
                    
                    if (data.success) {
                        currentStockData = data.history;
                        currentPage = 1;
                        displayStockInfo(data);
                        createPriceChart(data);
                        displayPriceTable();
                        calculatePriceStats(data.history);
                    } else {
                        document.getElementById('chartError').style.display = 'block';
                        document.getElementById('errorMessage').textContent = data.error;
                    }
                })
                .catch(error => {
                    console.error('Error loading stock history:', error);
                    document.getElementById('chartLoading').style.display = 'none';
                    document.getElementById('chartError').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'Error loading stock data. Please try again.';
                });
        }

        function displayStockInfo(data) {
            document.getElementById('stockInfo').style.display = 'block';
            document.getElementById('companyName').textContent = data.symbol;
            
            const dates = data.history.map(item => item.date);
            const startDate = dates[0];
            const endDate = dates[dates.length - 1];
            document.getElementById('dateRange').textContent = `${startDate} to ${endDate}`;
            
            document.getElementById('dataPoints').textContent = data.count.toLocaleString();
            
            const lastPrice = data.history[data.history.length - 1].open;
            document.getElementById('currentPrice').textContent = `$${lastPrice}`;
        }

        function createPriceChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (priceChart) {
                priceChart.destroy();
            }

            const chartData = {
                labels: data.history.map(item => item.date),
                datasets: [
                    {
                        label: 'Open Price',
                        data: data.history.map(item => item.open),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }
                ]
            };

            priceChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${data.symbol} Stock Price History`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price ($)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            document.getElementById('priceChart').style.display = 'block';
        }

        function calculatePriceStats(history) {
            if (history.length === 0) return;

            const prices = history.map(item => item.open).filter(price => price !== null);
            const firstPrice = prices[0];
            const lastPrice = prices[prices.length - 1];

            const highestPrice = Math.max(...prices);
            const lowestPrice = Math.min(...prices);
            const averagePrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
            const totalReturn = ((lastPrice - firstPrice) / firstPrice) * 100;

            document.getElementById('highestPrice').textContent = `$${highestPrice.toFixed(2)}`;
            document.getElementById('lowestPrice').textContent = `$${lowestPrice.toFixed(2)}`;
            document.getElementById('averagePrice').textContent = `$${averagePrice.toFixed(2)}`;
            document.getElementById('totalReturn').textContent = `${totalReturn.toFixed(2)}%`;
            document.getElementById('totalReturn').className = totalReturn >= 0 ? 'text-success' : 'text-danger';

            document.getElementById('priceStats').style.display = 'block';
        }

        function displayPriceTable() {
            if (currentStockData.length === 0) return;

            const tableBody = document.getElementById('priceTableBody');
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = currentStockData.slice(startIndex, endIndex);

            let html = '';
            pageData.forEach(item => {
                const dailyChangeClass = item.daily_change_pct >= 0 ? 'text-success' : 'text-danger';
                const dailyChangeIcon = item.daily_change_pct >= 0 ? '▲' : '▼';
                
                html += `
                    <tr>
                        <td><strong>${item.date}</strong></td>
                        <td>${item.prev_day_open ? '$' + item.prev_day_open.toFixed(2) : 'N/A'}</td>
                        <td>$${item.open ? item.open.toFixed(2) : 'N/A'}</td>
                        <td class="${dailyChangeClass}">
                            ${dailyChangeIcon} ${item.daily_change_pct ? item.daily_change_pct.toFixed(2) : 'N/A'}%
                        </td>
                        <td>${item.volume ? item.volume.toLocaleString() : 'N/A'}</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
            updatePagination();
            document.getElementById('priceTableContainer').style.display = 'block';
        }

        function updatePagination() {
            const totalPages = Math.ceil(currentStockData.length / pageSize);
            const pageInfo = document.getElementById('pageInfo');
            const prevButton = document.querySelector('button[onclick="previousPage()"]');
            const nextButton = document.querySelector('button[onclick="nextPage()"]');

            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayPriceTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(currentStockData.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                displayPriceTable();
            }
        }
    </script>
</body>
</html>

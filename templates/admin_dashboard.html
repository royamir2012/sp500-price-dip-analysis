<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - S&P 500 Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        .refresh-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        .nav-link {
            color: #667eea !important;
        }
        .nav-link:hover {
            color: #764ba2 !important;
        }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line me-3"></i>Admin Dashboard</h1>
                    <p class="mb-0">S&P 500 Price Dip Analysis - User Analytics</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/" class="btn btn-light me-2">
                        <i class="fas fa-home me-1"></i>Main App
                    </a>
                    <button class="btn btn-outline-light" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                    <i class="fas fa-tachometer-alt me-2"></i>Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab">
                    <i class="fas fa-users me-2"></i>User Sessions
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions" type="button" role="tab">
                    <i class="fas fa-list me-2"></i>Recent Actions
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                    <i class="fas fa-chart-bar me-2"></i>Analytics
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row">
                    <!-- Key Metrics -->
                    <div class="col-md-3">
                        <div class="stat-card text-center">
                            <div class="stat-number" id="totalSessions">-</div>
                            <div class="stat-label">Total Sessions</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center">
                            <div class="stat-number" id="totalPageViews">-</div>
                            <div class="stat-label">Page Views</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center">
                            <div class="stat-number" id="totalApiCalls">-</div>
                            <div class="stat-label">API Calls</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center">
                            <div class="stat-number" id="recentActions">-</div>
                            <div class="stat-label">Recent Actions (24h)</div>
                        </div>
                    </div>
                </div>

                <!-- Daily Activity Chart -->
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container">
                            <h5><i class="fas fa-chart-line me-2"></i>Daily Activity (Last 7 Days)</h5>
                            <canvas id="dailyActivityChart" height="100"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Pages and API Endpoints -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5><i class="fas fa-globe me-2"></i>Top Pages</h5>
                            <canvas id="topPagesChart" height="200"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5><i class="fas fa-cogs me-2"></i>Top API Endpoints</h5>
                            <canvas id="topApiChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div class="tab-pane fade" id="sessions" role="tabpanel">
                <div class="table-container">
                    <h5><i class="fas fa-users me-2"></i>User Sessions</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Session ID</th>
                                    <th>First Visit</th>
                                    <th>Last Activity</th>
                                    <th>IP Address</th>
                                    <th>Page Views</th>
                                    <th>API Calls</th>
                                    <th>Total Actions</th>
                                    <th>User Agent</th>
                                </tr>
                            </thead>
                            <tbody id="sessionsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center loading">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading sessions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Actions Tab -->
            <div class="tab-pane fade" id="actions" role="tabpanel">
                <div class="table-container">
                    <h5><i class="fas fa-list me-2"></i>Recent User Actions</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Action Type</th>
                                    <th>Details</th>
                                    <th>Session ID</th>
                                </tr>
                            </thead>
                            <tbody id="actionsTableBody">
                                <tr>
                                    <td colspan="4" class="text-center loading">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading actions...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-pane fade" id="analytics" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container">
                            <h5><i class="fas fa-chart-pie me-2"></i>Action Type Distribution</h5>
                            <canvas id="actionTypeChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="btn btn-primary refresh-btn" onclick="refreshData()" title="Refresh Data">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let analyticsData = null;
        let dailyActivityChart = null;
        let topPagesChart = null;
        let topApiChart = null;
        let actionTypeChart = null;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalyticsData();
            loadSessionsData();
            loadActionsData();
        });

        async function loadAnalyticsData() {
            try {
                const response = await fetch('/api/admin/analytics');
                const result = await response.json();
                
                if (result.success) {
                    analyticsData = result.data;
                    updateOverviewMetrics();
                    createCharts();
                } else {
                    console.error('Failed to load analytics:', result.error);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function updateOverviewMetrics() {
            document.getElementById('totalSessions').textContent = analyticsData.total_sessions || 0;
            document.getElementById('totalPageViews').textContent = analyticsData.total_page_views || 0;
            document.getElementById('totalApiCalls').textContent = analyticsData.total_api_calls || 0;
            document.getElementById('recentActions').textContent = analyticsData.recent_actions_count || 0;
        }

        function createCharts() {
            createDailyActivityChart();
            createTopPagesChart();
            createTopApiChart();
            createActionTypeChart();
        }

        function createDailyActivityChart() {
            const ctx = document.getElementById('dailyActivityChart').getContext('2d');
            
            const dailyStats = analyticsData.daily_stats || {};
            const dates = Object.keys(dailyStats).sort();
            const uniqueUsers = dates.map(date => dailyStats[date].unique_users || 0);
            const pageViews = dates.map(date => dailyStats[date].page_views || 0);
            const apiCalls = dates.map(date => dailyStats[date].api_calls || 0);

            if (dailyActivityChart) {
                dailyActivityChart.destroy();
            }

            dailyActivityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Unique Users',
                            data: uniqueUsers,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Page Views',
                            data: pageViews,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'API Calls',
                            data: apiCalls,
                            borderColor: '#f093fb',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createTopPagesChart() {
            const ctx = document.getElementById('topPagesChart').getContext('2d');
            const topPages = analyticsData.top_pages || {};
            
            if (topPagesChart) {
                topPagesChart.destroy();
            }

            topPagesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(topPages),
                    datasets: [{
                        data: Object.values(topPages),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe',
                            '#00f2fe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function createTopApiChart() {
            const ctx = document.getElementById('topApiChart').getContext('2d');
            const topApi = analyticsData.top_api_endpoints || {};
            
            if (topApiChart) {
                topApiChart.destroy();
            }

            topApiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(topApi),
                    datasets: [{
                        label: 'API Calls',
                        data: Object.values(topApi),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createActionTypeChart() {
            const ctx = document.getElementById('actionTypeChart').getContext('2d');
            
            // Count action types from recent actions
            const actionTypes = {};
            (analyticsData.recent_actions || []).forEach(action => {
                actionTypes[action.action_type] = (actionTypes[action.action_type] || 0) + 1;
            });
            
            if (actionTypeChart) {
                actionTypeChart.destroy();
            }

            actionTypeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(actionTypes),
                    datasets: [{
                        data: Object.values(actionTypes),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe',
                            '#00f2fe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        async function loadSessionsData() {
            try {
                const response = await fetch('/api/admin/sessions');
                const result = await response.json();
                
                if (result.success) {
                    updateSessionsTable(result.sessions);
                } else {
                    console.error('Failed to load sessions:', result.error);
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function updateSessionsTable(sessions) {
            const tbody = document.getElementById('sessionsTableBody');
            tbody.innerHTML = '';

            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No sessions found</td></tr>';
                return;
            }

            sessions.forEach(session => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${session.session_id.substring(0, 8)}...</code></td>
                    <td>${new Date(session.first_visit).toLocaleString()}</td>
                    <td>${new Date(session.last_activity).toLocaleString()}</td>
                    <td>${session.ip_address}</td>
                    <td><span class="badge bg-primary">${session.page_views}</span></td>
                    <td><span class="badge bg-info">${session.api_calls}</span></td>
                    <td><span class="badge bg-success">${session.total_actions}</span></td>
                    <td><small>${session.user_agent.substring(0, 50)}...</small></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadActionsData() {
            try {
                const response = await fetch('/api/admin/actions');
                const result = await response.json();
                
                if (result.success) {
                    updateActionsTable(result.actions);
                } else {
                    console.error('Failed to load actions:', result.error);
                }
            } catch (error) {
                console.error('Error loading actions:', error);
            }
        }

        function updateActionsTable(actions) {
            const tbody = document.getElementById('actionsTableBody');
            tbody.innerHTML = '';

            if (actions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No actions found</td></tr>';
                return;
            }

            actions.reverse().forEach(action => {
                const row = document.createElement('tr');
                const details = action.details ? JSON.stringify(action.details) : '';
                row.innerHTML = `
                    <td>${new Date(action.timestamp).toLocaleString()}</td>
                    <td><span class="badge bg-secondary">${action.action_type}</span></td>
                    <td><small>${details}</small></td>
                    <td><code>${action.session_id.substring(0, 8)}...</code></td>
                `;
                tbody.appendChild(row);
            });
        }

        function refreshData() {
            // Show loading state
            document.getElementById('totalSessions').textContent = '...';
            document.getElementById('totalPageViews').textContent = '...';
            document.getElementById('totalApiCalls').textContent = '...';
            document.getElementById('recentActions').textContent = '...';

            // Reload all data
            loadAnalyticsData();
            loadSessionsData();
            loadActionsData();
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
